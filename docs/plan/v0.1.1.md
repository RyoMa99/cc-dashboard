# CC Dashboard テスト・品質強化計画

## Context

v0.1（OTLP レシーバー + SSR ダッシュボード）が完成し、パーサー層のみテスト済み（38ケース）。
ルートハンドラー、認証ミドルウェア、リポジトリ、クエリ関数がすべて未テストのため、
データ永続化の信頼性や認証の安全性に根拠ある自信がない状態。

テスト基盤を整備し、リスクの高い層から段階的にテストを追加することで、
今後の機能追加（v0.2 チャート可視化等）やデプロイに向けた品質基盤を構築する。

## スコープ

**やること:**
- D1 テスト基盤の整備（マイグレーション自動適用、型定義）
- 認証ミドルウェアのテスト（セキュリティリスク最優先）
- リポジトリ層のテスト（データ永続化の正確性）
- クエリ層のテスト（集計ロジックの正確性）
- OTLP ルートのインテグレーションテスト

**やらないこと:**
- ダッシュボード UI コンポーネントの詳細テスト（SSR HTML の構造テストは ROI が低い）
- VRT（Storybook 未導入のため不要）
- E2E テスト（ローカルのみの現段階では不要）

---

## タスク

### タスク 0: プラン管理の規約整備

**変更対象**:
- `docs/plan/v0.1.1.md`（新規 — 本計画の永続化）
- `CLAUDE.md`（既存 — プラン管理規約の追記）

### タスク 1: D1 テスト基盤の整備

**変更対象**:
- `vitest.config.ts`（既存、修正）
- `test/apply-migrations.ts`（新規）
- `test/env.d.ts`（新規）
- `tsconfig.json`（既存、`test/` を include に追加）

### タスク 2: 認証ミドルウェアのテスト

**変更対象**: `src/middleware/auth.test.ts`（新規）

**受入条件（bearerAuth）**:
- WHEN 有効な Bearer token 付きリクエスト THEN 次のハンドラーに到達し 200 を返す
- WHEN Authorization ヘッダーなし THEN 401 Unauthorized を返す
- WHEN 無効な token THEN 401 Unauthorized を返す
- WHEN "Bearer " プレフィックスなしで token のみ THEN 401 Unauthorized を返す

**受入条件（dashboardAuth）**:
- WHEN 有効な `cc_dashboard_session` Cookie 付きリクエスト THEN 次のハンドラーに到達し 200 を返す
- WHEN Cookie なし + 有効な `?token=` クエリパラメータ THEN Set-Cookie ヘッダー付きで 302 リダイレクト
- WHEN リダイレクト先 URL に token パラメータが含まれない THEN URL から token が除去されている
- WHEN Cookie なし + token パラメータなし THEN 401 Unauthorized を返す
- WHEN Cookie なし + 無効な token パラメータ THEN 401 Unauthorized を返す

### タスク 3: リポジトリ層のテスト

**変更対象**:
- `src/repositories/events.test.ts`（新規）
- `src/repositories/metrics.test.ts`（新規）

**受入条件（events.ts）**:
- WHEN 1件の ParsedApiRequest を渡す THEN api_requests テーブルに1行挿入され、全カラムの値が一致する
- WHEN 複数件の ParsedApiRequest を渡す THEN 全件がバッチ挿入される
- WHEN 空配列を渡す THEN DB 操作を行わず正常終了する（早期リターン）
- WHEN 1件の ParsedToolResult を渡す THEN tool_results テーブルに1行挿入される
- WHEN 1件の ParsedApiError を渡す THEN api_errors テーブルに1行挿入される

**受入条件（metrics.ts）**:
- WHEN 1件の ParsedMetricDataPoint を渡す THEN metric_data_points テーブルに1行挿入され、attributes_json が正しく JSON 文字列化されている
- WHEN nullable フィールド（sessionId, attrType, attrModel）が null THEN NULL として保存される
- WHEN 空配列を渡す THEN DB 操作を行わず正常終了する

### タスク 4: クエリ層のテスト

**変更対象**: `src/queries/dashboard.test.ts`（新規）

**受入条件（getOverviewStats）**:
- WHEN api_requests に2件（cost 0.01 + 0.02, tokens 100+200/50+100）が存在 THEN totalCost=0.03, totalInputTokens=300, totalOutputTokens=150, apiCalls=2
- WHEN api_errors に1件が存在 THEN errorCount=1
- WHEN データが空 THEN 全フィールドが 0 または null

**受入条件（getDailyTokens）**:
- WHEN 異なる日付のレコードが存在 THEN 日付ごとに集計され、降順で返される
- WHEN 同一日付に複数レコード THEN トークン数が合算される

**受入条件（getDailyCosts）**:
- WHEN 同一日付・異なるモデルのレコードが存在 THEN モデルごとに行が分かれる
- WHEN 同一日付・同一モデルの複数レコード THEN コストと呼び出し数が合算される

**受入条件（getToolUsage）**:
- WHEN 同一ツールで success=true が 3件、success=false が 1件 THEN calls=4, successRate=75.0
- WHEN duration_ms が [100, 200, 300] THEN avgDuration=200

**受入条件（getRecentSessions）**:
- WHEN 2セッション（s1: api_requests 2件 + tool_results 1件, s2: api_requests 1件 + tool_results 0件）THEN 2行返され、s1 の toolCalls=1, s2 の toolCalls=0（LEFT JOIN）
- WHEN 21セッション THEN 上位20件のみ返される（LIMIT）

### タスク 5: OTLP ルートのインテグレーションテスト

**変更対象**: `src/routes/otlp.test.ts`（新規）

**受入条件（POST /v1/logs）**:
- WHEN 有効な Bearer token + 有効な OTLP ログペイロード（api_request 1件）THEN 200 + `{"partialSuccess":{}}` を返し、api_requests テーブルに1行挿入される
- WHEN 有効な Bearer token + 空の logRecords THEN 200 を返し、テーブルに挿入なし
- WHEN 無効な Bearer token THEN 401 を返し、テーブルに挿入なし
- WHEN Authorization ヘッダーなし THEN 401 を返す

**受入条件（POST /v1/metrics）**:
- WHEN 有効な Bearer token + 有効な OTLP メトリクスペイロード THEN 200 + `{"partialSuccess":{}}` を返し、metric_data_points テーブルに行が挿入される
- WHEN 無効な Bearer token THEN 401 を返す
