# CC Dashboard Workers デプロイ + Cloudflare Access + chezmoi 1Password 連携

## Context

CC Dashboard を Cloudflare Workers にデプロイしたい。2つの課題がある：

1. **認証トークンの管理**: `~/.claude/settings.json` は chezmoi 経由で GitHub 公開リポジトリにあるため、トークンを直接書けない
2. **ダッシュボードの保護**: `?token=` によるURL漏洩リスクと、トークンが唯一の防御線である問題

**解決策**:
- **ダッシュボード** → Cloudflare Access（ゼロトラスト認証）で保護。`?token=` 方式を廃止
- **OTLP API**（`/v1/*`）→ Cloudflare Access バイパス + Bearer Token（Claude Code との互換性維持）
- **chezmoi** → 1Password テンプレート統合で `settings.json` のトークン・エンドポイントを安全に管理

---

## タスク 0: 計画ファイル保存

**変更対象**: `docs/plan/v0.2.0.md`

---

## タスク 1: D1 データベース作成 + wrangler.toml 更新

**変更対象**: `wrangler.toml`

**手順**:
1. `wrangler d1 create cc-dashboard-db` で本番 D1 を作成
2. 返された `database_id` を `wrangler.toml` に設定
3. `pnpm db:migrate:remote` でマイグレーション適用

**受入条件**:
- WHEN `wrangler d1 list` THEN `cc-dashboard-db` が表示される
- WHEN `pnpm db:migrate:remote` THEN マイグレーションが正常適用される

---

## タスク 2: AUTH_TOKEN を Cloudflare Secrets に設定

**手順**:
1. 強力なトークンを生成（`openssl rand -base64 32`）
2. `wrangler secret put AUTH_TOKEN` で設定
3. 同じトークンを 1Password に保存（タスク 6 で使用）

**受入条件**:
- WHEN `wrangler secret list` THEN `AUTH_TOKEN` が表示される

---

## タスク 3: ダッシュボード認証を Cloudflare Access に委譲

**変更対象**:
- `src/middleware/auth.ts` - `dashboardAuth` ミドルウェアの削除
- `src/routes/dashboard.tsx` - ミドルウェア適用の削除
- `src/middleware/auth.test.ts` - テスト更新

**方針**:
Cloudflare Access がダッシュボードの認証を担当するため、Workers 側の `dashboardAuth`（`?token=` + Cookie）を削除。
`bearerAuth`（OTLP API 用）はそのまま維持。

ローカル開発時は Cloudflare Access が介在しないため、`pnpm dev` でダッシュボードに直接アクセスできる。

**受入条件**:
- WHEN `dashboardAuth` が削除されている THEN `?token=` によるURL漏洩リスクが解消
- WHEN OTLP API に Bearer Token で POST THEN 従来通り認証が通る
- WHEN ローカル開発（`pnpm dev`）THEN ダッシュボードに直接アクセス可能

---

## タスク 4: Workers デプロイ

**手順**:
1. `pnpm deploy` でデプロイ
2. デプロイされた URL を確認（`https://cc-dashboard.<account>.workers.dev`）

**受入条件**:
- WHEN Bearer Token で POST `/v1/logs` THEN `{"partialSuccess":{}}`
- WHEN 認証なしで POST `/v1/logs` THEN 401

---

## タスク 5: Cloudflare Access 設定

**手順**（Cloudflare Dashboard で実施）:
1. Zero Trust → Access → Applications で新規アプリケーション作成
2. アプリケーション名: `CC Dashboard`
3. ドメイン: `cc-dashboard.<account>.workers.dev`
4. パスの設定:
   - ダッシュボード（`/`）→ Access ポリシー適用（メール OTP or Google OAuth）
   - OTLP API（`/v1/*`）→ バイパスポリシー
5. ポリシー: Allow + メール一致ルール（自分のメールアドレスのみ許可）

**受入条件**:
- WHEN ダッシュボードにアクセス THEN Cloudflare Access のログイン画面が表示される
- WHEN 認証後 THEN ダッシュボードが表示される
- WHEN `/v1/logs` に Bearer Token で POST THEN Access を経由せず直接認証される

---

## タスク 6: 1Password CLI セットアップ + シークレット作成

**手順**:
1. `brew install 1password-cli`
2. 1Password デスクトップアプリで「開発者」→「CLI統合」を有効化
3. `op signin` で認証確認
4. 1Password に「CC Dashboard」アイテムを作成:
   - `token`: タスク 2 で生成したトークン
   - `endpoint`: Workers の URL

**受入条件**:
- WHEN `op --version` THEN バージョンが表示される
- WHEN `op read "op://Personal/CC Dashboard/token"` THEN トークンが返る

---

## タスク 7: chezmoi settings.json テンプレート化

**変更対象**: chezmoi ソース `dot_claude/settings.json` → `dot_claude/settings.json.tmpl`

**変更内容**（OTLP 関連の 2 フィールドのみテンプレート化）:
```json.tmpl
"OTEL_EXPORTER_OTLP_ENDPOINT": "{{ onepasswordRead "op://Personal/CC Dashboard/endpoint" }}",
"OTEL_EXPORTER_OTLP_HEADERS": "Authorization=Bearer {{ onepasswordRead "op://Personal/CC Dashboard/token" }}"
```

**手順**:
1. chezmoi ソースで `settings.json` を `settings.json.tmpl` にリネーム
2. OTLP 関連の 2 フィールドをテンプレート関数に置換
3. `chezmoi diff` で差分確認
4. `chezmoi apply` で適用

**受入条件**:
- WHEN `chezmoi apply` THEN `~/.claude/settings.json` に 1Password の値が展開される
- WHEN 1Password のトークンを変更 → `chezmoi apply` THEN 新しいトークンが反映される

---

## タスク 8: エンドツーエンド動作確認

**手順**:
1. `chezmoi apply` で settings.json を更新
2. Claude Code を起動して OTLP データが Workers に送信されることを確認
3. Workers のダッシュボードに Cloudflare Access 経由でアクセスしてデータが表示されることを確認

**受入条件**:
- WHEN Claude Code で操作 THEN Workers の `/v1/logs` にデータが送信される
- WHEN ダッシュボードにアクセス THEN Cloudflare Access 認証後にデータが表示される

---

## 作業の分類

| タスク | 作業場所 | 種類 |
|--------|---------|------|
| 0 | cc-dashboard リポジトリ | ファイル保存 |
| 1-2 | cc-dashboard + Cloudflare CLI | インフラ設定 |
| 3 | cc-dashboard リポジトリ | コード変更 |
| 4 | cc-dashboard + Cloudflare CLI | デプロイ |
| 5 | Cloudflare Dashboard（GUI） | インフラ設定 |
| 6-7 | ローカル環境 + chezmoi リポジトリ | 設定変更 |
| 8 | 全体 | 動作確認 |

## 注意事項

- タスク 2 で生成したトークンをタスク 6 で 1Password に保存する（同じ値を使う）
- 1Password の vault 名・アイテム名はユーザーの環境に合わせて調整
- Cloudflare Access の設定はGUIでの作業が必要（`wrangler` CLI では設定不可）
- ローカル開発時は Cloudflare Access が介在しないため、`dashboardAuth` 削除後は `pnpm dev` でダッシュボードに直接アクセスできる
