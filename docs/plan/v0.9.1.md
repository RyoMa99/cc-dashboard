# v0.9.1: 本番データ検証で発見したバグ修正

## Context

PR #32 (v0.9.0) のマージ前に本番 D1 データを検証し、2つの問題を発見した。

### 本番データの実態

| 項目 | 計画時の想定 | 実際 |
|------|------------|------|
| MCP の `tool_name` | `mcp__<server>__<tool>` | `"mcp_tool"`（全MCP共通） |
| `tool_parameters` の Bash キー | `command` | `bash_command`, `full_command`, `description`, `timeout` |
| MCP レコード数 | - | 173件（うち `tool_parameters` あり 21件、NULL 152件） |

- `OTEL_LOG_TOOL_DETAILS=1` 有効前のデータ（152件）は `tool_parameters = NULL` → バックフィル不可
- [公式ドキュメント](https://code.claude.com/docs/en/monitoring-usage) で `tool_result` の `tool_parameters` 仕様を確認済み

### 発見した問題

**問題1（バグ）: GROUP BY が不十分で MCP ツールが1行に集約される**

```sql
-- 現在: mcp_server_name/mcp_tool_name で分割されない
GROUP BY tr.tool_name, tr.skill_name

-- 本番データ: tool_name="mcp_tool" かつ skill_name=NULL の全レコード（173件）が
-- navigate_page も take_screenshot も全部1行にまとまる
```

**問題2（表示不正）: `tool_name="mcp_tool"` + `mcpServerName=NULL` が "builtin" 扱い**

現在の `getToolDisplayInfo` は `mcpServerName` が NULL で `mcp__` プレフィックスにもマッチしない場合、case 5（builtin）に落ちる。
本番の旧データ（152件）は `{ displayName: "mcp_tool", category: "builtin" }` と表示され、MCP ツールであることが分からない。

## タスク

### タスク 1: GROUP BY に `mcp_server_name`, `mcp_tool_name` を追加

**変更対象**: `src/queries/dashboard.ts` — `getToolUsage()`

```sql
-- Before
GROUP BY tr.tool_name, tr.skill_name

-- After
GROUP BY tr.tool_name, tr.mcp_server_name, tr.mcp_tool_name, tr.skill_name
```

**受入条件**:
- WHEN 同じ `tool_name="mcp_tool"` に異なる `mcp_tool_name` がある THEN 別行で返る
- WHEN `mcp_server_name` と `mcp_tool_name` が NULL THEN 1行にまとまる（旧データ）

### タスク 2: `tool_name="mcp_tool"` のフォールバック表示

**変更対象**: `src/lib/tool-display.ts` — `getToolDisplayInfo()`

`mcp__` プレフィックスフォールバック（case 2）の後、`toolName === "mcp_tool"` のケースを追加:

```typescript
// 3. toolName === "mcp_tool"（OTEL_LOG_TOOL_DETAILS 無効時の旧データ）
if (row.toolName === "mcp_tool") {
  return {
    displayName: "mcp_tool",
    category: "mcp",
    serverName: null,
  };
}
```

**テスト追加**: `src/lib/tool-display.test.ts`

**受入条件**:
- WHEN `toolName="mcp_tool"` かつ `mcpServerName=NULL` THEN `category: "mcp"`, `serverName: null`
- WHEN `toolName="mcp_tool"` かつ `mcpServerName="chrome-devtools"` THEN 既存ロジック（case 1）で処理

### タスク 3: CLAUDE.md の `tool_parameters` キー記述を修正

**変更対象**: `CLAUDE.md`

前回セッションで追記した `tool_parameters` の記述を公式ドキュメントに合わせて修正:

```
- `tool_result` イベントの `tool_parameters` 属性は JSON 文字列。既知のキー:
  Bash: `bash_command`, `full_command`, `description`, `timeout`
  MCP (`OTEL_LOG_TOOL_DETAILS=1`): `mcp_server_name`, `mcp_tool_name`
  Skill (`OTEL_LOG_TOOL_DETAILS=1`): `skill_name`
```

## 変更対象ファイル一覧

| ファイル | 変更種別 |
|---------|---------|
| `src/queries/dashboard.ts` | 修正（GROUP BY） |
| `src/lib/tool-display.ts` | 修正（mcp_tool フォールバック追加） |
| `src/lib/tool-display.test.ts` | 修正（テストケース追加） |
| `CLAUDE.md` | 修正（tool_parameters キー記述） |
