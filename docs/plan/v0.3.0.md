# SSR SVG チャート表示の追加 (v0.3.0)

## Context

CC Dashboard は現在すべてテーブル/カード表示のみ。日別コスト・トークン・ツール使用状況の3データセットをチャートで可視化し、トレンドを直感的に把握できるようにする。

**方針**: Hono JSX SSR で SVG を直接生成。クライアント JS なし、追加依存ゼロ。既存テーブルは残し、チャートをその上に配置する。

---

## タスク 0: 計画ファイル保存

**変更対象**: `docs/plan/v0.3.0.md`

---

## タスク 1: SVG 要素の型宣言追加

**変更対象**: `src/types/jsx-svg.d.ts`（新規）

Hono JSX の `IntrinsicElements` を拡張し、SVG 要素（`svg`, `rect`, `g`, `line`, `text`, `title`）の型を追加する。Hono JSX は SVG 名前空間を認識するが、TypeScript の型定義にSVG要素が含まれないため。

**受入条件**:
- WHEN チャートコンポーネントで SVG 要素を使用 THEN TypeScript 型エラーなし
- WHEN `pnpm typecheck` THEN 成功

---

## タスク 2: チャート共有ユーティリティ

**変更対象**: `src/components/charts/chart-utils.ts`（新規）

**I/O シグネチャ**:

```typescript
function scaleLinear(domain: [number, number], range: [number, number]): (value: number) => number;
function niceMax(value: number): number;
function formatCompact(n: number): string;
function formatCostAxis(usd: number): string;

const MODEL_COLORS: string[];         // blue-400, emerald-400, amber-400, red-400, violet-400
const TOKEN_COLORS: Record<"input" | "output" | "cacheRead" | "cacheCreate", string>;
const BAR_COLOR: string;              // blue-400
const PADDING: { top: number; right: number; bottom: number; left: number; legend: number };
```

**受入条件**:
- WHEN `scaleLinear([0, 100], [0, 200])(50)` THEN `100`
- WHEN `scaleLinear([0, 100], [200, 0])(0)` THEN `200`（Y軸反転）
- WHEN `niceMax(0)` THEN `1`（ゼロ除算回避）
- WHEN `niceMax(73)` THEN `80`
- WHEN `niceMax(0.0073)` THEN `0.008`（小数対応）
- WHEN `formatCompact(0)` THEN `"0"`
- WHEN `formatCompact(1500)` THEN `"1.5K"`
- WHEN `formatCompact(2500000)` THEN `"2.5M"`
- WHEN `formatCostAxis(0.5)` THEN `"$0.50"`

**依存**: タスク 1

---

## タスク 3: 日別トークン積み上げ棒グラフ

**変更対象**: `src/components/charts/DailyTokenChart.tsx`（新規）

**I/O シグネチャ**: `(props: { rows: DailyTokenRow[] }) => JSX.Element | null`

- viewBox `0 0 600 320`、SVG `width="100%"` でレスポンシブ
- X軸: MM/DD 形式、間引き表示。Y軸: formatCompact + グリッド線4本
- 4種別の積み上げ棒（input → output → cacheRead → cacheCreate）
- 凡例: チャート下部に横並び
- `<title>` でネイティブツールチップ（「日付: 種別 値」）
- データは `.slice().reverse()` で ASC 反転

**受入条件**:
- WHEN rows が空 THEN null を返す
- WHEN rows が1件 THEN 単一の棒が描画される
- WHEN rows が複数件 THEN 日付昇順で左→右に並ぶ
- WHEN 各棒 THEN 4種別が下から積み上がる
- WHEN 全トークンが0の日 THEN 棒高さ0でエラーなし
- WHEN SVG 出力 THEN 凡例テキスト含む

**依存**: タスク 1, 2（タスク 4, 5 と並列可能）

---

## タスク 4: 日別コスト積み上げ棒グラフ

**変更対象**: `src/components/charts/DailyCostChart.tsx`（新規）

**I/O シグネチャ**: `(props: { rows: DailyCostRow[] }) => JSX.Element | null`

- `DailyCostRow[]`（date+model ペア）を日付ごとにグループ化する前処理が必要
- モデル別の色は `MODEL_COLORS` から出現順に割り当て（最大5色、超過時は最後の色再利用）
- Y軸: `formatCostAxis` 使用
- それ以外の構造はタスク 3 と同様

**受入条件**:
- WHEN rows が空 THEN null を返す
- WHEN 1日に2モデル THEN 2色の積み上げ棒
- WHEN 複数日 THEN 日付昇順で左→右（DESC 反転）
- WHEN モデル6つ以上 THEN エラーなし（最後の色再利用）
- WHEN `<title>` THEN 「日付: モデル名 $コスト」

**依存**: タスク 1, 2（タスク 3, 5 と並列可能）

---

## タスク 5: ツール使用状況水平棒グラフ

**変更対象**: `src/components/charts/ToolUsageChart.tsx`（新規）

**I/O シグネチャ**: `(props: { tools: ToolUsageRow[] }) => JSX.Element | null`

- viewBox `0 0 600 {30 * toolCount + 20}`（可変高さ）
- 左側: ツール名ラベル、右側: 水平棒 + 数値ラベル
- 棒色: `BAR_COLOR` 単色
- `<title>` に「ツール名: N calls, 成功率%, 平均 Xms」

**受入条件**:
- WHEN tools が空 THEN null を返す
- WHEN tools が複数件 THEN callCount 降順で上から並ぶ
- WHEN ツール名が長い THEN レイアウト崩れなし

**依存**: タスク 1, 2（タスク 3, 4 と並列可能）

---

## タスク 6: 既存コンポーネントへのチャート統合

**変更対象**:
- `src/components/DailyTokens.tsx` — `<h2>` とテーブルの間に `DailyTokenChart` 挿入
- `src/components/DailyCosts.tsx` — 同上、`DailyCostChart` 挿入
- `src/components/ToolUsage.tsx` — 同上、`ToolUsageChart` 挿入

**受入条件**:
- WHEN ダッシュボード表示 THEN 各セクションでチャートがテーブル上に表示
- WHEN データ空 THEN チャート非表示、テーブルの空メッセージのみ
- WHEN レスポンシブ THEN SVG が親要素幅に追従

**依存**: タスク 3, 4, 5

---

## 検証手順

1. `pnpm typecheck` — 型チェック通過
2. `pnpm test` — ユーティリティのユニットテスト通過
3. `pnpm dev` → chrome-devtools MCP でスクリーンショット — チャート表示・レイアウト確認
4. 空 DB で表示 — チャートが非表示でテーブルの空メッセージが表示
5. OTLP データ投入後に再表示 — チャートにデータが反映

## ファイル構成（新規）

```
src/
  types/jsx-svg.d.ts              # タスク 1
  components/charts/
    chart-utils.ts                # タスク 2
    DailyTokenChart.tsx           # タスク 3
    DailyCostChart.tsx            # タスク 4
    ToolUsageChart.tsx            # タスク 5
```
