# v0.5.0 データ基盤: OTLP イベント・属性の取得拡張

Issue: #6 | Phase: 1-foundation | 規模: Medium（4タスク）

## Context

現在のダッシュボードは `api_request` / `tool_result` / `api_error` の3イベントのみキャプチャしている。後続機能（セッション詳細 #7、リポジトリ別集計 #8）の基盤として、新しいイベント型とリソース属性の取得を拡張する。

設計ドキュメント: `docs/plan/2026-02-16-data-enrichment-design.md`

---

## タスク 0: 計画ファイル保存 + 作業ブランチ作成

**変更対象**: `docs/plan/v0.5.0.md`, git branch

ブランチ: `feature/otlp-event-extension`

---

## タスク 1: DB スキーマ マイグレーション

**変更対象**: `migrations/0002_event_extension.sql`（新規）

テスト基盤（`readD1Migrations`）は `migrations/` を自動で読み込むため、設定変更は不要。

**受入条件**:
- WHEN マイグレーション適用 THEN `sessions`, `user_prompts`, `tool_decisions` テーブルが作成される
- WHEN マイグレーション適用 THEN `tool_results` に `tool_parameters` カラム（nullable）が追加される
- WHEN 既存データがある THEN `tool_parameters` は NULL（後方互換）

---

## タスク 2: ドメイン型 + パーサー拡張

**変更対象**:
- `src/types/domain.ts` — 新型追加、既存型拡張
- `src/parsers/otlp-logs.ts` — パーサー関数追加、戻り値変更
- `src/parsers/otlp-logs.test.ts` — テスト追加・既存テスト更新

### I/O シグネチャ

```typescript
// --- 新規型 ---
type ParsedUserPrompt = {
  sessionId: string;
  eventSequence: number | null;
  timestampNs: string;
  timestampMs: number;
  promptLength: number;
  prompt: string | null;
};

type ParsedToolDecision = {
  sessionId: string;
  eventSequence: number | null;
  timestampNs: string;
  timestampMs: number;
  toolName: string;
  decision: string;
  source: string | null;
};

// --- 既存型拡張 ---
// ParsedToolResult に追加
toolParameters: string | null;

// ParsedLogEvent union に追加
| { type: "user_prompt"; data: ParsedUserPrompt }
| { type: "tool_decision"; data: ParsedToolDecision }

// --- 新規型: リソースコンテキスト ---
type ParsedResourceContext = {
  sessionId: string;
  repository: string | null;
};

// --- 戻り値変更 ---
type ParseLogsResult = {
  events: ParsedLogEvent[];
  resourceContexts: ParsedResourceContext[];
};

// parseLogsPayload: ParsedLogEvent[] → ParseLogsResult
```

### 設計判断: `parseLogsPayload` の戻り値変更

`repository` は resource attributes レベル（logRecord ではなく resourceLogs レベル）にある。選択肢：
- A: 各イベント型に `repository` を追加 → 冗長、DRY 違反
- **B: events + resourceContexts を返す → 採用。関心の分離が明確**
- C: パーサー内で session upsert → パーサーの責務を超える

### 既存テスト影響

`otlp-logs.test.ts:173-179` の「未知の event.name は unknown として返す」テスト（`user_prompt` を unknown として検証）を `user_prompt` パース成功に更新する。全既存テストで戻り値を `result.events` に変更。

### 受入条件

**正常系**:
- WHEN `user_prompt` イベント（`prompt_length=150`, `prompt="Hello"`）THEN `ParsedUserPrompt` に正しくパースされる
- WHEN `tool_decision` イベント（`tool_name="Bash"`, `decision="reject"`, `source="user"`）THEN `ParsedToolDecision` に正しくパースされる
- WHEN `tool_result` に `tool_parameters='{"command":"ls"}'` THEN `toolParameters` に JSON 文字列が格納される
- WHEN resource attributes に `repository=cc-dashboard` THEN `resourceContexts[0].repository` が `"cc-dashboard"`

**異常系・境界値**:
- WHEN `user_prompt` に `prompt` 属性なし THEN `prompt` は `null`（opt-in）
- WHEN `user_prompt` に `prompt_length` なし THEN `promptLength` は `0`
- WHEN `tool_decision` に `source` なし THEN `source` は `null`
- WHEN `tool_result` に `tool_parameters` なし THEN `toolParameters` は `null`（後方互換）
- WHEN resource attributes に `repository` なし THEN `repository` は `null`
- WHEN 既存 `api_request` / `tool_result` / `api_error` ペイロード THEN 既存と同一結果（後方互換）

**依存**: タスク 1

---

## タスク 3: リポジトリ層 — insert 関数 + session upsert

**変更対象**:
- `src/repositories/events.ts` — 関数追加、既存関数修正
- `src/repositories/events.test.ts` — テスト追加

### I/O シグネチャ

```typescript
// 新規
async function insertUserPrompts(db: D1Database, prompts: ParsedUserPrompt[]): Promise<void>;
async function insertToolDecisions(db: D1Database, decisions: ParsedToolDecision[]): Promise<void>;

// Session upsert
type SessionUpsertData = {
  sessionId: string;
  repository: string | null;
  timestampMs: number;
};
async function upsertSessions(db: D1Database, sessions: SessionUpsertData[]): Promise<void>;

// 既存修正: insertToolResults に tool_parameters バインド追加（10→11パラメータ）
```

### Session upsert SQL

```sql
INSERT INTO sessions (session_id, repository, first_event_at, last_event_at)
VALUES (?, ?, ?, ?)
ON CONFLICT(session_id) DO UPDATE SET
  repository = COALESCE(excluded.repository, sessions.repository),
  first_event_at = MIN(sessions.first_event_at, excluded.first_event_at),
  last_event_at = MAX(sessions.last_event_at, excluded.last_event_at)
```

- `COALESCE`: 後続イベントの repository が null でも既存値を保持
- `MIN/MAX`: 順序外配信に対応

### 受入条件

**正常系**:
- WHEN `insertUserPrompts` with 1件 THEN `user_prompts` に行が存在
- WHEN `insertToolDecisions` with 1件 THEN `tool_decisions` に行が存在
- WHEN `upsertSessions` with 新規 session_id THEN `first_event_at = last_event_at = timestampMs`
- WHEN `insertToolResults` with `toolParameters='{"command":"ls"}'` THEN `tool_parameters` カラムに格納

**異常系・境界値**:
- WHEN 空配列 THEN DB 操作なし、正常終了
- WHEN `upsertSessions` with 既存 session_id + 後のタイムスタンプ THEN `last_event_at` 更新、`first_event_at` 保持
- WHEN `upsertSessions` with 既存 session_id + 前のタイムスタンプ THEN `first_event_at` 更新、`last_event_at` 保持
- WHEN `upsertSessions` with `repository=null` + 既存行に repository あり THEN 既存 repository 保持
- WHEN `upsertSessions` with `repository="new"` + 既存行の repository が null THEN repository 更新
- WHEN `insertToolResults` with `toolParameters=null` THEN `tool_parameters` は NULL（後方互換）

**依存**: タスク 1, タスク 2

---

## タスク 4: ルートハンドラ統合 + E2E テスト

**変更対象**:
- `src/routes/otlp.ts` — 新イベント dispatch + session upsert 呼び出し
- `src/routes/otlp.test.ts` — 統合テスト追加

### ルートハンドラ変更

```typescript
// Before
const events = parseLogsPayload(body);

// After
const { events, resourceContexts } = parseLogsPayload(body);
// ... 既存の flatMap + 新イベント flatMap ...
const sessionUpserts = buildSessionUpserts(events, resourceContexts);
await Promise.all([
  /* 既存 + 新規 insert + upsertSessions */
]);
```

`buildSessionUpserts` ヘルパー（`otlp.ts` 内）: 全イベントから sessionId + timestampMs を収集し、resourceContexts から repository を紐付け。sessionId ごとに重複排除して `SessionUpsertData[]` を返す。

### 受入条件

**正常系**:
- WHEN `user_prompt` イベント POST THEN 200 + `user_prompts` に行が存在
- WHEN `tool_decision` イベント POST THEN 200 + `tool_decisions` に行が存在
- WHEN `tool_result` + `tool_parameters` POST THEN 200 + `tool_parameters` が格納
- WHEN resource attributes に `repository=cc-dashboard` THEN `sessions` に `repository` が記録
- WHEN `api_request`（既存イベント）POST THEN `sessions` に `first_event_at` / `last_event_at` が記録
- WHEN 混合ペイロード（複数イベント型）POST THEN 全イベント格納 + sessions 正しく upsert

**後方互換**:
- WHEN 既存テストペイロード送信 THEN 全既存アサーション通過

**依存**: タスク 2, タスク 3
