# v0.7.0: リポジトリ別コスト集計・フィルタ (Issue #8)

## Context

ダッシュボードに**リポジトリ（プロジェクト）別のコスト集計とフィルタリング機能**を追加する。
現在は全セッションを一括表示しているが、Claude Code を複数プロジェクトで使う場合にリポジトリ別のコスト把握ができない。

`sessions.repository` カラム・インデックスおよびOTLP取込処理は Issue #6 で完了済み。
本タスクはUI・クエリ層の対応。

## 設計判断

| 判断 | 選択 | 理由 |
|------|------|------|
| フィルタのURLパラメータ名 | `repo` | 短く可読性が高い。GitHub慣習と一致 |
| repository IS NULL の表現 | URL: `?repo=__uncategorized__`, 表示: 「未分類」 | sentinel値で明確に区別 |
| フィルタ時のJOIN戦略 | `repo` パラメータなし→JOINなし（現行動作維持）、あり→`JOIN sessions` | 未フィルタ時のパフォーマンス劣化を防止 |
| RecentSessions の repository 取得 | 常に `LEFT JOIN sessions` | フィルタ有無に関わらず列表示が必要 |
| RepositoryCosts のフィルタ | 常に全リポジトリ表示（フィルタ対象外） | 比較コンテキストとして全体俯瞰を維持 |

## 内部型の設計

```typescript
// フィルタの3状態を表現
// undefined → フィルタなし（全データ）
// string   → WHERE s.repository = ?
// null     → WHERE s.repository IS NULL（未分類）
type RepoFilter = string | null | undefined;
```

URL パラメータからの変換:
- `?repo` なし → `undefined`
- `?repo=cc-dashboard` → `"cc-dashboard"`
- `?repo=__uncategorized__` → `null`

## タスク

### タスク 1: 既存クエリに repository フィルタを追加

**変更対象**: `src/queries/dashboard.ts`, `src/queries/dashboard.test.ts`

全5関数に `repo?: RepoFilter` パラメータ追加。`buildRepoJoin` ヘルパーで SQL 構築を共通化。
SessionRow に `repository: string | null` フィールド追加。

### タスク 2: リポジトリ別コスト集計クエリ + リポジトリ一覧クエリを追加

**変更対象**: `src/queries/dashboard.ts`, `src/queries/dashboard.test.ts`

`getRepositoryCosts(db)` と `getDistinctRepositories(db)` の2つの新規クエリ関数を追加。

### タスク 3: RepositoryFilter / RepositoryCosts コンポーネント作成

**変更対象**: `src/components/RepositoryFilter.tsx`, `src/components/RepositoryCosts.tsx`, `src/components/charts/RepositoryCostChart.tsx`

### タスク 4: ルート統合 + RecentSessions 更新

**変更対象**: `src/routes/dashboard.tsx`, `src/components/RecentSessions.tsx`

ルートで `repo` パラメータをパースし全クエリにフィルタを渡す。RecentSessions に Repository 列追加。
