# v0.6.0 セッション詳細ページ（タイムラインビュー）

## Context

Issue #7。セッション内の全イベントを時系列で表示する新ページ。
データ基盤（#6）はマージ済みで、5つのイベントテーブル（api_requests, tool_results, user_prompts, tool_decisions, api_errors）と sessions テーブルが利用可能。

**ゴール**: `GET /session/:id` で全イベントをカード形式のタイムラインとして表示
**スコープ外**: ページネーション、リポジトリフィルタ（#8）、クライアント JS

---

## 設計判断

| # | 判断 | 理由 |
|---|------|------|
| D1 | 5テーブル並列クエリ → アプリ層でマージ・ソート | UNION ALL はスキーマ差が大きく複雑。既存の `Promise.all` パターンに合致 |
| D2 | `TimelineEvent` 判別共用体を `src/queries/session.ts` に定義 | `ParsedLogEvent`（OTLP パーサー用）と責務が異なる。DB行→表示用の型 |
| D3 | format ヘルパーを `src/lib/format.ts` に抽出 | `formatCost` 等が Overview.tsx と RecentSessions.tsx で重複。セッション詳細でも使う |
| D4 | セッション不在時は 404 HTML | `sessions` テーブルで存在確認。API ではなく SSR ページなので HTML で返す |
| D5 | リンクは単純に `/session/{id}` | ダッシュボードの認証は Cloudflare Access が担当。トークン引き回し不要 |

---

## タスク

### タスク 0: 計画ファイル保存 + ブランチ作成

`docs/plan/v0.6.0.md` に計画を保存。`feature/session-detail-page` ブランチを main から作成。

---

### タスク 1: format ヘルパーの共通化

**変更対象**:
- `src/lib/format.ts`（新規）
- `src/lib/format.test.ts`（新規）
- `src/components/RecentSessions.tsx`（import 変更）
- `src/components/Overview.tsx`（import 変更）
- `src/components/DailyCosts.tsx`（import 変更、`formatCost` 使用箇所を確認）

**I/O シグネチャ**:
```typescript
formatCost(usd: number) → string          // "$0.0123"
formatTokens(n: number) → string           // "1.5M" / "1.5K" / "999"
formatTime(ms: number) → string            // "2025-01-15 12:00:00"
formatDuration(firstMs: number, lastMs: number) → string  // "2m"
formatDurationMs(ms: number) → string      // "1.5s" / "150ms"（新規、単一duration用）
```

**受入条件**:
- WHEN `formatCost(0.0123)` THEN `"$0.0123"`
- WHEN `formatTokens(1_500_000)` THEN `"1.5M"`
- WHEN `formatTokens(1500)` THEN `"1.5K"`
- WHEN `formatTokens(999)` THEN `"999"`
- WHEN `formatDurationMs(1500)` THEN `"1.5s"`
- WHEN `formatDurationMs(150)` THEN `"150ms"`
- WHEN `formatDurationMs(0)` THEN `"0ms"`
- WHEN 既存テスト・型チェック THEN パス（リグレッションなし）

---

### タスク 2: セッションクエリ層

**変更対象**:
- `src/queries/session.ts`（新規）
- `src/queries/session.test.ts`（新規）

**I/O シグネチャ**:
```typescript
type SessionInfo = {
  sessionId: string;
  repository: string | null;
  firstEventAt: number;
  lastEventAt: number;
};

type TimelineEvent =
  | { type: "user_prompt"; eventSequence: number | null; timestampMs: number; promptLength: number; prompt: string | null }
  | { type: "api_request"; eventSequence: number | null; timestampMs: number; model: string; costUsd: number; durationMs: number; inputTokens: number; outputTokens: number; cacheReadTokens: number; cacheCreationTokens: number }
  | { type: "tool_result"; eventSequence: number | null; timestampMs: number; toolName: string; success: boolean; durationMs: number; error: string | null; toolParameters: string | null }
  | { type: "tool_decision"; eventSequence: number | null; timestampMs: number; toolName: string; decision: string; source: string | null }
  | { type: "api_error"; eventSequence: number | null; timestampMs: number; model: string | null; error: string; statusCode: number | null; durationMs: number; attempt: number };

getSessionInfo(db: D1Database, sessionId: string) → Promise<SessionInfo | null>
getSessionTimeline(db: D1Database, sessionId: string) → Promise<TimelineEvent[]>
```

`getSessionTimeline` は 5 テーブルを `Promise.all` で並列クエリし、結果をマージして `event_sequence`（null は末尾）→ `timestamp_ms` でソート。

**受入条件**:
- WHEN 存在する sessionId THEN `SessionInfo` を返す
- WHEN 存在しない sessionId THEN `null` を返す
- WHEN 5テーブルすべてにイベントがある THEN 全イベントが event_sequence → timestamp_ms 順で返る
- WHEN event_sequence が null THEN timestamp_ms でソートされ、非 null の後に配置
- WHEN 1テーブルのみにイベント THEN そのイベントのみ返る
- WHEN イベントが0件 THEN 空配列を返す
- WHEN tool_result の success = 1 THEN `success === true`

**依存**: なし（型は自己完結）

---

### タスク 3: タイムラインコンポーネント

**変更対象**:
- `src/components/SessionTimeline.tsx`（新規）

**I/O シグネチャ**:
```typescript
SessionTimeline(props: { session: SessionInfo; events: TimelineEvent[] }) → JSX.Element
```

**イベントカード表示仕様**:

| イベント | アクセント色 | 表示フィールド |
|---------|------------|--------------|
| user_prompt | blue | 文字数。`prompt` 非 null なら `<details>` で全文表示 |
| api_request | green | モデル、コスト、トークン（in/out/cache）、所要時間 |
| tool_result | 成功: green / 失敗: red | ツール名、成功/失敗バッジ、所要時間。Bash + toolParameters なら command 表示 |
| tool_decision | yellow | ツール名、accept/reject バッジ、source |
| api_error | red | モデル、エラー、ステータスコード、所要時間、attempt |

**受入条件**:
- WHEN events 非空 THEN セッションヘッダー（ID, リポジトリ, 期間）+ イベントカードを時系列表示
- WHEN user_prompt で prompt 非 null THEN `<details>` で全文展開可能
- WHEN user_prompt で prompt null THEN 文字数のみ表示
- WHEN tool_result で toolName="Bash" かつ toolParameters に command THEN コマンド表示
- WHEN tool_result で toolParameters が不正 JSON THEN クラッシュせず表示
- WHEN events 空 THEN "No events found" メッセージ
- WHEN レンダリング THEN ダークテーマ（bg-gray-900 等）で既存と統一

**依存**: タスク 1（format ヘルパー）、タスク 2（型定義）

---

### タスク 4: ルート登録 + RecentSessions リンク

**変更対象**:
- `src/routes/dashboard.tsx`（`GET /session/:id` 追加）
- `src/components/RecentSessions.tsx`（session ID を `<a>` リンク化）

**受入条件**:
- WHEN `GET /session/{existingId}` THEN 200 + タイムライン HTML
- WHEN `GET /session/{nonExistentId}` THEN 404 + エラーページ HTML
- WHEN RecentSessions テーブル THEN session ID が `/session/{id}` へのリンク
- WHEN セッション詳細ページ THEN ダッシュボードへの戻りリンクあり

**依存**: タスク 2, タスク 3
