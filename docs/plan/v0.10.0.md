# v0.10.0: 分析メトリクス追加（キャッシュ効率・コスト効率・コード変更行数）

## Context

Issue #9: Overview ダッシュボードに3つの分析メトリクスを追加し、Claude Code 利用のコスト効率と生産性を可視化する。

- **キャッシュ効率**: `cache_read_tokens / input_tokens` でキャッシュヒット率を算出（既存データから計算可能）
- **コスト効率**: `cost_usd / output_tokens` でモデル別の単価を表示（新クエリ必要）
- **コード変更行数**: `metric_data_points` テーブルの `claude_code.lines_of_code.count` から抽出（新クエリ必要）+ コスト/行数 = ROI メトリクス

DB スキーマ変更なし。既存テーブルとデータから全て導出可能。

---

## タスク 0: 計画ファイル保存 + 作業ブランチ作成

**変更対象**: `docs/plan/v0.10.0.md`, git branch `feature/analytics-metrics`

---

## タスク 1: formatPercent / formatCostPerToken ユーティリティ追加

**変更対象**: `src/lib/format.ts`, `src/lib/format.test.ts`

### `formatPercent(ratio: number): string`

ratio は 0.0〜1.0 の比率。

**受入条件**:
- WHEN `formatPercent(0.856)` THEN `"85.6%"`
- WHEN `formatPercent(0)` THEN `"0.0%"`
- WHEN `formatPercent(1)` THEN `"100.0%"`
- WHEN ratio が NaN THEN `"N/A"`

### `formatCostPerToken(costPerToken: number): string`

output token 1個あたりのコストを 1K tokens あたりに正規化して表示。

**受入条件**:
- WHEN `formatCostPerToken(0.00012)` THEN `"$0.12 / 1K tokens"`
- WHEN `formatCostPerToken(0)` THEN `"$0.00 / 1K tokens"`
- WHEN NaN THEN `"N/A"`

**依存**: なし

---

## タスク 2: コスト効率クエリ追加（モデル別）

**変更対象**: `src/queries/dashboard.ts`

**型定義**:
```typescript
export type CostEfficiencyRow = {
  model: string;
  totalCost: number;
  totalOutputTokens: number;
  costPerOutputToken: number;
  apiCallCount: number;
};
```

**I/O**: `getCostEfficiency(db: D1Database, repo?: RepoFilter): Promise<CostEfficiencyRow[]>`

**依存**: なし

---

## タスク 3: コード変更行数クエリ追加

**変更対象**: `src/queries/dashboard.ts`

**型定義**:
```typescript
export type LinesOfCodeStats = {
  linesAdded: number;
  linesRemoved: number;
};
```

**I/O**: `getLinesOfCodeStats(db: D1Database, repo?: RepoFilter): Promise<LinesOfCodeStats>`

**依存**: なし

---

## タスク 4: seed データに metric_data_points 追加

**変更対象**: `scripts/seed.ts`

**依存**: なし

---

## タスク 5: Overview コンポーネント拡張（キャッシュ効率 + コード変更行数カード）

**変更対象**: `src/components/Overview.tsx`, `src/routes/dashboard.tsx`

**依存**: タスク 1, タスク 3

---

## タスク 6: コスト効率セクション追加

**変更対象**: `src/components/CostEfficiency.tsx`（新規）, `src/routes/dashboard.tsx`

**依存**: タスク 1, タスク 2
